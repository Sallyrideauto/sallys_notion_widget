<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
  /* --- CSS 변수 및 다크모드 설정 --- */
  :root {
    --text-main: #37352f;
    --text-sub: #787774;
    --bg-input: rgba(255, 255, 255, 0.6);
    --border-color: rgba(55, 53, 47, 0.16);
    --hover-bg: rgba(55, 53, 47, 0.08);
    --accent-color: #e16259;
    --danger-color: #eb5757;
    --progress-color: #2e8b57;
    --bar-bg: rgba(55, 53, 47, 0.08);
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --text-main: #d9d9d9;
      --text-sub: #9b9b9b;
      --bg-input: rgba(255, 255, 255, 0.1);
      --border-color: rgba(255, 255, 255, 0.13);
      --hover-bg: rgba(255, 255, 255, 0.08);
      --progress-color: #6fcf97;
      --bar-bg: rgba(255, 255, 255, 0.1);
    }
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    padding: 20px;
    background-color: transparent;
    color: var(--text-main);
    margin: 0;
  }

  /* 타이머 스타일 */
  .timer-box { text-align: center; margin-bottom: 20px; }
  .time { font-size: 56px; font-weight: 700; font-variant-numeric: tabular-nums; letter-spacing: -2px; margin-bottom: 10px; }
  
  .btn-group { display: flex; justify-content: center; gap: 10px; }
  .btn {
    padding: 6px 16px; border: 1px solid var(--border-color); border-radius: 6px;
    background: var(--bg-input); color: var(--text-main); cursor: pointer;
    font-size: 14px; transition: background 0.2s;
  }
  .btn:hover { background: var(--hover-bg); }
  .btn.start { border-color: var(--accent-color); color: var(--accent-color); font-weight: 600; }

  /* 총 달성률 바 스타일 */
  .daily-progress-container { margin-bottom: 20px; }
  .daily-label { font-size: 12px; color: var(--text-sub); display: flex; justify-content: space-between; margin-bottom: 5px; }
  .progress-bar-bg {
    width: 100%; height: 8px; background: var(--bar-bg); border-radius: 4px; overflow: hidden;
  }
  .progress-bar-fill {
    height: 100%; width: 0%; background: var(--accent-color); border-radius: 4px;
    transition: width 0.4s ease;
  }

  /* 리스트 스타일 */
  .task-input {
    width: 100%; padding: 10px; border: 1px solid var(--border-color);
    background: var(--bg-input); color: var(--text-main);
    border-radius: 6px; box-sizing: border-box; outline: none; font-size: 14px;
  }
  .task-list { list-style: none; padding: 0; margin-top: 15px; }
  .task-item {
    margin-bottom: 8px; padding: 8px; border-radius: 6px;
    transition: background 0.2s; border: 1px solid transparent;
  }
  .task-item:hover { background: var(--hover-bg); border-color: var(--border-color); }

  .task-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; }
  .task-left { display: flex; align-items: center; gap: 8px; flex-grow: 1; }
  .task-title { font-size: 15px; font-weight: 500; }
  
  .sub-percent { font-size: 12px; color: var(--progress-color); font-weight: 600; margin-left: 5px; }

  .task-controls { display: flex; align-items: center; gap: 8px; }
  .details-btn { font-size: 12px; color: var(--text-sub); background: none; border: none; cursor: pointer; }
  .delete-btn { color: var(--text-sub); background: none; border: none; cursor: pointer; font-size: 16px; opacity: 0.5; }
  .delete-btn:hover { color: var(--danger-color); opacity: 1; }

  .sub-tasks-container {
    display: none; margin-top: 10px; padding-left: 28px;
    border-left: 2px solid var(--border-color); margin-left: 4px;
  }
  .show { display: block; }

  .sub-input {
    width: 100%; padding: 6px; background: transparent;
    border: none; border-bottom: 1px dashed var(--border-color);
    color: var(--text-sub); font-size: 13px; outline: none; margin-bottom: 8px;
  }
  .sub-task-list { list-style: none; padding: 0; }
  .sub-task-item {
    display: flex; align-items: center; justify-content: space-between;
    font-size: 13px; color: var(--text-sub); padding: 3px 0; cursor: pointer; user-select: none;
  }
  .sub-task-left { display: flex; align-items: center; gap: 6px; }

  .done { text-decoration: line-through; opacity: 0.6; }
  .icon-check { min-width: 18px; text-align: center; }
</style>
</head>
<body>

<div class="timer-box">
  <div class="time" id="timer">25:00</div>
  <div class="btn-group">
    <button class="btn start" onclick="startTimer()">Start</button>
    <button class="btn" onclick="resetTimer()">Reset</button>
  </div>
</div>

<div class="daily-progress-container">
  <div class="daily-label">
    <span>오늘의 달성률</span>
    <span id="dailyPercent">0%</span>
  </div>
  <div class="progress-bar-bg">
    <div class="progress-bar-fill" id="dailyBar"></div>
  </div>
</div>

<input type="text" class="task-input" id="mainTaskInput" placeholder="+ 오늘 할 일 추가 (Enter)">
<ul class="task-list" id="taskList"></ul>

<script>
  // --- 1. 저장소 및 날짜 관리 로직 ---
  const STORAGE_KEY = 'notion_pomodoro_tasks';
  const DATE_KEY = 'notion_pomodoro_date';

  // 페이지 로드 시 실행
  window.onload = function() {
    checkDateAndLoad();
  };

  function checkDateAndLoad() {
    const today = new Date().toLocaleDateString();
    const savedDate = localStorage.getItem(DATE_KEY);

    if (savedDate !== today) {
      // 날짜가 다르면(새로운 날) 초기화
      localStorage.setItem(DATE_KEY, today);
      localStorage.removeItem(STORAGE_KEY);
      renderTasks([]); // 빈 리스트 렌더링
    } else {
      // 같은 날이면 데이터 불러오기
      const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      renderTasks(savedData);
    }
    updateDailyProgress();
  }

  function saveData() {
    const tasks = [];
    document.querySelectorAll('.task-item').forEach(item => {
      const title = item.querySelector('.task-title').innerText;
      const isDone = item.querySelector('.task-title').classList.contains('done');
      
      const subTasks = [];
      item.querySelectorAll('.sub-task-item').forEach(sub => {
        subTasks.push({
          text: sub.querySelector('.sub-text').innerText,
          done: sub.querySelector('.sub-text').classList.contains('done')
        });
      });

      tasks.push({ title, done: isDone, subs: subTasks });
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
    updateDailyProgress();
  }

  // 데이터 기반 렌더링 함수
  function renderTasks(data) {
    const list = document.getElementById('taskList');
    list.innerHTML = '';
    data.forEach(task => {
      createTaskElement(task.title, task.done, task.subs);
    });
  }

  // --- 2. 타이머 로직 (기존 동일) ---
  let timeLeft = 1500; let interval; let isRunning = false;
  function updateDisplay() {
    const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
    const s = (timeLeft % 60).toString().padStart(2, '0');
    document.getElementById('timer').innerText = `${m}:${s}`;
    document.title = `${m}:${s} - Pomodoro`;
  }
  function startTimer() {
    if(isRunning) { clearInterval(interval); isRunning = false; document.querySelector('.start').innerText = 'Resume'; return; }
    isRunning = true; document.querySelector('.start').innerText = 'Pause';
    interval = setInterval(() => {
      timeLeft--; updateDisplay();
      if(timeLeft === 0) { clearInterval(interval); isRunning = false; alert('집중 시간 종료!'); resetTimer(); }
    }, 1000);
  }
  function resetTimer() { clearInterval(interval); isRunning = false; timeLeft = 1500; updateDisplay(); document.querySelector('.start').innerText = 'Start'; }

  // --- 3. 태스크 관리 로직 ---
  const taskInput = document.getElementById('mainTaskInput');
  taskInput.addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
      if (!this.value) return;
      createTaskElement(this.value, false, []);
      this.value = '';
      saveData();
    }
  });

  function createTaskElement(text, isDone, subTasksData) {
    const li = document.createElement('li');
    li.className = 'task-item';
    
    li.innerHTML = `
      <div class="task-header">
        <div class="task-left" onclick="toggleMainDone(this)">
          <span class="icon-check">${isDone ? '✅' : '⬜'}</span> 
          <span class="task-title ${isDone ? 'done' : ''}">${text}</span>
          <span class="sub-percent"></span>
        </div>
        <div class="task-controls">
          <button class="details-btn" onclick="toggleDetails(this)">Details ▼</button>
          <button class="delete-btn" onclick="deleteTask(this)">×</button>
        </div>
      </div>
      <div class="sub-tasks-container">
        <input type="text" class="sub-input" placeholder="↳ 하위 할 일 입력 후 Enter..." onkeypress="addSubTask(event, this)">
        <ul class="sub-task-list"></ul>
      </div>
    `;
    
    // 하위 데이터 복원
    const subList = li.querySelector('.sub-task-list');
    subTasksData.forEach(sub => {
      createSubTaskElement(subList, sub.text, sub.done);
    });

    document.getElementById('taskList').appendChild(li);
    updateSubProgress(li);
  }

  function toggleMainDone(div) {
    const textSpan = div.querySelector('.task-title');
    const iconSpan = div.querySelector('.icon-check');
    if (textSpan.classList.contains('done')) {
      textSpan.classList.remove('done'); iconSpan.innerText = '⬜';
    } else {
      textSpan.classList.add('done'); iconSpan.innerText = '✅';
      // 메인 완료 시 하위 항목도 모두 완료 처리 원할 경우 여기에 로직 추가 가능
      // (현재는 메인만 완료 표시)
    }
    saveData();
  }

  function deleteTask(btn) {
    if(confirm('삭제하시겠습니까?')) {
      btn.closest('.task-item').remove();
      saveData();
    }
  }

  function toggleDetails(btn) {
    const subContainer = btn.closest('.task-header').nextElementSibling;
    subContainer.classList.toggle('show');
    btn.innerText = subContainer.classList.contains('show') ? 'Close ▲' : 'Details ▼';
    if(subContainer.classList.contains('show')) subContainer.querySelector('.sub-input').focus();
  }

  // --- 4. 하위 태스크 로직 및 자동 완료 기능 ---
  function addSubTask(event, input) {
    if (event.key === 'Enter') {
      if (!input.value) return;
      createSubTaskElement(input.nextElementSibling, input.value, false);
      input.value = '';
      
      // 하위 태스크 추가되면 메인의 완료 상태를 재계산(체크 풀림 방지 등)
      checkAutoMainComplete(input.closest('.task-item'));
      updateSubProgress(input.closest('.task-item'));
      saveData();
    }
  }

  function createSubTaskElement(ul, text, isDone) {
    const li = document.createElement('li');
    li.className = 'sub-task-item';
    li.innerHTML = `
      <div class="sub-task-left" onclick="toggleSubDone(this)">
        <span class="icon-check">${isDone ? '✔' : '◽'}</span> 
        <span class="sub-text ${isDone ? 'done' : ''}">${text}</span>
      </div>
      <button class="delete-btn" onclick="deleteSubTask(this)">×</button>
    `;
    ul.appendChild(li);
  }

  function toggleSubDone(div) {
    const textSpan = div.querySelector('.sub-text');
    const iconSpan = div.querySelector('.icon-check');
    const taskItem = div.closest('.task-item');

    if (textSpan.classList.contains('done')) {
      textSpan.classList.remove('done'); iconSpan.innerText = '◽';
    } else {
      textSpan.classList.add('done'); iconSpan.innerText = '✔';
    }
    
    checkAutoMainComplete(taskItem); // 메인 태스크 자동 완료 체크
    updateSubProgress(taskItem);
    saveData();
  }

  // [핵심 기능] 하위 태스크 상태에 따른 메인 태스크 자동 처리
  function checkAutoMainComplete(taskItem) {
    const subItems = taskItem.querySelectorAll('.sub-task-item');
    const doneItems = taskItem.querySelectorAll('.sub-text.done');
    const mainTitle = taskItem.querySelector('.task-title');
    const mainIcon = taskItem.querySelector('.task-left .icon-check');

    if (subItems.length > 0) {
      if (subItems.length === doneItems.length) {
        // 모두 완료되면 메인도 완료
        if (!mainTitle.classList.contains('done')) {
          mainTitle.classList.add('done');
          mainIcon.innerText = '✅';
        }
      } else {
        // 하나라도 미완료면 메인은 미완료
        if (mainTitle.classList.contains('done')) {
          mainTitle.classList.remove('done');
          mainIcon.innerText = '⬜';
        }
      }
    }
  }

  function deleteSubTask(btn) {
    const li = btn.closest('.sub-task-item');
    const taskItem = li.closest('.task-item');
    li.remove();
    checkAutoMainComplete(taskItem);
    updateSubProgress(taskItem);
    saveData();
  }

  // --- 5. 퍼센트 계산 및 통합 업데이트 ---
  function updateSubProgress(taskItem) {
    const subList = taskItem.querySelector('.sub-task-list');
    const totalSub = subList.querySelectorAll('.sub-task-item').length;
    const doneSub = subList.querySelectorAll('.sub-text.done').length;
    const percentSpan = taskItem.querySelector('.sub-percent');

    if (totalSub === 0) {
      percentSpan.innerText = '';
    } else {
      const percent = Math.round((doneSub / totalSub) * 100);
      percentSpan.innerText = `(${percent}%)`;
      percentSpan.style.color = percent === 100 ? '#2e8b57' : 'var(--progress-color)';
    }
  }

  function updateDailyProgress() {
    const tasks = document.querySelectorAll('.task-item');
    const total = tasks.length;
    let doneCount = 0;

    tasks.forEach(task => {
      if (task.querySelector('.task-title').classList.contains('done')) {
        doneCount++;
      }
    });

    const percent = total === 0 ? 0 : Math.round((doneCount / total) * 100);
    
    document.getElementById('dailyPercent').innerText = `${percent}%`;
    document.getElementById('dailyBar').style.width = `${percent}%`;
    
    // 달성률 100%면 바 색상 변경 (초록색)
    if(percent === 100 && total > 0) {
        document.getElementById('dailyBar').style.backgroundColor = '#2e8b57';
    } else {
        document.getElementById('dailyBar').style.backgroundColor = 'var(--accent-color)';
    }
  }
</script>

</body>
</html>
